---
title: "Test Read-out File"
date: "`r format(Sys.time(), '%c')`"
output: 
  html_document:
    df_print: paged
    toc: no
    toc_depth: '3'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

``` {r tabulate function, include=FALSE}
library(DT)

# Overall Summary of Datacut Tab####
data_review <- function(pt_data, dt_data, dm_data, no_cut){
  cyc_num <- 1
   sum_t <- tibble(Dataset = character(), 
                   `Cut Applied` = character(),
                   `Before Cut` = numeric(), 
                   `After Cut` = numeric(),
                   `Removed` = numeric(), 
                   `Modified` = numeric())
  # Patient Cut Data
  for (df in pt_data){
    name <- names(pt_data)[cyc_num]
    x <- length(which(df$DCUT_TEMP_REMOVE == "Y"))
    uncut <- nrow(df)
    cut <- length(which(is.na(df$DCUT_TEMP_REMOVE)))
    sum_t <- add_row(sum_t,
                     Dataset = toupper(name),
                     `Cut Applied` = "PATIENT",
                     `Before Cut`= uncut,
                     `After Cut` = cut,
                     `Removed` = x,
                     `Modified` = NA)
    cyc_num <- cyc_num + 1
  }
  # Date Cut Data
  cyc_num <- 1
  for (df in dt_data){
   name <- names(dt_data)[cyc_num]
   x <- length(which(df$DCUT_TEMP_REMOVE == "Y"))
   uncut <- nrow(df)
   cut <- length(which(is.na(df$DCUT_TEMP_REMOVE)))
   sum_t <- add_row(sum_t,
                     Dataset = toupper(name),
                     `Cut Applied` = "DATE",
                     `Before Cut`= uncut,
                     `After Cut` = cut,
                     `Removed` = x,
                     `Modified` = NA)
   cyc_num <- cyc_num + 1
  }
  # Uncut Data
  cyc_num <- 1
  for (df in no_cut){
   name <- names(no_cut)[cyc_num]
   uncut <- nrow(df)
   sum_t <- add_row(sum_t,
                     Dataset = toupper(name),
                     `Cut Applied` = "NO CUT",
                     `Before Cut`= uncut,
                     `After Cut` = uncut,
                     `Removed` = NA,
                     `Modified` = NA)
   cyc_num <- cyc_num + 1
  }
  # DM Cut Data
  if (!is.null(dm_data)){
    x <- length(which(dm_data$DCUT_TEMP_REMOVE == "Y"))
    y <- length(which(dm_data$DCUT_TEMP_DTHCHANGE == "Y"))
    uncut <- nrow(dm_data)
    cut <- length(which(is.na(dm_data$DCUT_TEMP_REMOVE)))
    sum_t <- add_row(sum_t,
                       Dataset = "DM",
                       `Cut Applied` = "DM",
                       `Before Cut`= uncut,
                       `After Cut` = cut,
                       `Removed` = x,
                       `Modified` = y)
  } 
    # Custom table container
  sketch = htmltools::withTags(table(
     class = 'display',
     thead(
        tr(
           th(rowspan = 2, 'Dataset'),
           th(rowspan = 2, 'Cut Applied'),
           th(colspan = 4, 'Total Number of Records')
        ),
        tr(
           lapply(names(sum_t)[-c(1,2)], th)
        )
     )
  ))
  DT::datatable(sum_t, container = sketch, filter = 'top', rownames = FALSE)
}

# Create tabs in the html ####
# df_tabs <- function(data){
#   cyc_num <- 1
#   # case when data = NULL
#   if (is.null(data)) {
#     return(cat("If you would like to apply this cut, please double check you have ran this cut / filled in all the parameters in process_cut() when using the wrapped approach"))
#   } else {
#   # include modified records in special dm cut 
#   if (exists("DCUT_TEMP_DTHCHANGE", where = data)) {
#     cat("####", "DM", " \n")
#     datatable(data)
#       x <- length(which(data$DCUT_TEMP_REMOVE == "Y"))
#         cat(paste("Number of records removed in DM: ", x, " \n"))
#       y <- length(which(data$DCUT_TEMP_DTHCHANGE == "Y"))
#         cat(paste("Number of records modified in DM: ", y, " \n", " \n"))
#       print(htmltools::tagList(DT::datatable(data, filter = 'top', rownames = FALSE, 
#                                            options = list(scrollX = TRUE, fixedColumns = TRUE)) %>%
#                                formatStyle("DCUT_TEMP_DTHCHANGE",
#                                             target = "row",
#                                             color = 'black', 
#                                             backgroundColor = styleEqual("Y", '#DFF3FF')) %>%
#                                formatStyle("DCUT_TEMP_REMOVE",
#                                             target = "row",
#                                             color = 'black', 
#                                             backgroundColor = styleEqual("Y",'#FFDFDF'))))
#       cat(' \n\n')
#   } else {
#     # table for each df in the datacut
#     for (df in data){
#       datatable(NULL)
#       name <- names(data)[cyc_num]
#       cat("####", toupper(name), " \n")
#       if (exists("DCUT_TEMP_REMOVE", where = df)){
#         x <- length(which(df$DCUT_TEMP_REMOVE == "Y"))
#         cat(paste("Number of records removed in ", toupper(name), ": ", x, " \n", " \n"))
#         print(htmltools::tagList(DT::datatable(df, filter = 'top', 
#                                                options = list(scrollX = TRUE, fixedColumns = TRUE)) %>%
#                                    formatStyle("DCUT_TEMP_REMOVE",
#                                                 target = "row",
#                                                 color = 'black', 
#                                                 backgroundColor = styleEqual("Y",'#FFDFDF'))))
#       } else {
#       print(htmltools::tagList(DT::datatable(df, filter = 'top', 
#                                              options = list(scrollX = TRUE, fixedColumns = TRUE))))
#       }
#       cat(' \n\n')
#       cyc_num <- cyc_num + 1
#     }}
#   }
# }

# Summary Tab for each cut
sum_test <- function(data){
  cyc_num <- 1
  cat("####", "Summary", " \n")
   sum_t <- tibble(Dataset = character(), 
                   `Before Cut` = numeric(), 
                   `After Cut` = numeric(),
                   `Removed` = numeric())
   # case when data = NULL
  if (is.null(data)) {
    cat("No data has been cut with this cut type")
    cat(' \n\n')
  } else {
   # DM-specific Summary Tab
   if (exists("DCUT_TEMP_DTHCHANGE", where = data)) {
        datatable(data)
        x <- length(which(data$DCUT_TEMP_REMOVE == "Y"))
        y <- length(which(data$DCUT_TEMP_DTHCHANGE == "Y"))
        uncut <- nrow(data)
        cut <- length(which(is.na(data$DCUT_TEMP_REMOVE)))
        sum_t <- tibble(Dataset = character(), 
                        `Before Cut` = numeric(), 
                        `After Cut` = numeric(), 
                        Removed = numeric(), 
                        Modified = numeric()) %>% 
          add_row(Dataset = "DM", `Before Cut` = uncut, `After Cut` = cut, Removed = x, Modified = y)
        sketch = htmltools::withTags(table(class = 'display',
                                           thead(tr(th(rowspan = 2, 'Dataset'),
                                                    th(colspan = 4, 'Total Number of Records')),
                                                 tr(lapply(names(sum_t)[-1], th)))
                                           ))
        print(htmltools::tagList(DT::datatable(sum_t, container = sketch, rownames = FALSE)))
        cat(' \n\n')
     } else { 
      # Summary tabs for other cuts
        for (df in data){
          name <- names(data)[cyc_num]
          x <- length(which(df$DCUT_TEMP_REMOVE == "Y"))
          uncut <- nrow(df)
          cut <- length(which(is.na(df$DCUT_TEMP_REMOVE)))
          sum_t <- add_row(sum_t, 
                           Dataset = toupper(name), 
                           `Before Cut` = uncut,
                           `After Cut` = cut,
                           `Removed` = x)
          cat(' \n\n')
          cyc_num <- cyc_num + 1
        }
           sketch = htmltools::withTags(table(class = 'display',
                                              thead(tr(th(rowspan = 2, 'Dataset'),
                                                       th(colspan = 3, 'Total Number of Records')),
                                                    tr(lapply(names(sum_t)[-1], th)))
                                              ))
         DT::datatable(sum_t, container = sketch, filter = 'top', rownames = FALSE, 
                       options = list(scrollX = TRUE, fixedColumns = TRUE))
     }
  }
}

df_tables <- function(data){
  if (is.null(data)) {
    cat("No data has been cut with this cut type")
    cat(' \n\n')
  } else {
  lapply(data, function(df){
    datatable(NULL)
    name <- names(df)
      cat("####", toupper(name), " \n")
    x <- length(which(df$DCUT_TEMP_REMOVE == "Y"))
      cat(paste("Number of records removed in ", toupper(name), ": ", x, " \n", " \n"))
    print(htmltools::tagList(DT::datatable(df, filter = 'top', 
                                           options = list(scrollX = TRUE, fixedColumns = TRUE)) %>%
                               formatStyle("DCUT_TEMP_REMOVE",
                                           target = "row",
                                           color = 'black', 
                                           backgroundColor = styleEqual("Y",'#FFDFDF'))))
    cat(' \n\n')
  })
 }
}

dm_tab <- function(data){
  if (is.null(data)) {
    cat("No data has been cut with this cut type")
    cat(' \n\n')
  } else { 
     datatable(data)
     cat("####", "DM", " \n")
      x <- length(which(data$DCUT_TEMP_REMOVE == "Y"))
        cat(paste("Number of records removed in DM: ", x, " \n"))
      y <- length(which(data$DCUT_TEMP_DTHCHANGE == "Y"))
        cat(paste("Number of records modified in DM: ", y, " \n", " \n"))
      print(htmltools::tagList(DT::datatable(data, filter = 'top', rownames = FALSE, 
                                           options = list(scrollX = TRUE, fixedColumns = TRUE)) %>%
                               formatStyle("DCUT_TEMP_DTHCHANGE",
                                            target = "row",
                                            color = 'black', 
                                            backgroundColor = styleEqual("Y", '#DFF3FF')) %>%
                               formatStyle("DCUT_TEMP_REMOVE",
                                            target = "row",
                                            color = 'black', 
                                            backgroundColor = styleEqual("Y",'#FFDFDF'))))
      cat(' \n\n')
  }
}

```

### Details

This is an {datacur} auto-generated read-out file. It contains a summary of the changes made to the data after the cut has been applied.

The **Summary** tab outlines the datasets affected and what type of cut has been applied to each. 

You can investigate each of the types of cuts applied and look at the data itself by looking at the **Datacut Dataset (DCUT)**, **Patient Cut**, **Date Cut** and **Special DM Cut** tabs. 

The **Final Data** tab contains all the datasets after the cut has been applied. 

---

# {.tabset}

## Summary

### Summary of Datacut

---

```{r Review, echo = FALSE}
data_review(patient_cut_data, date_cut_data, dm_cut, no_cut_list)
```

## Datacut Dataset (DCUT)

### DCUT dataset:

After filtering the input DS dataset (based on the given filter condition), any records where the SDTMv date/time variable is on or before the datacut date/time (after imputations) will be returned in the output datacut dataset (DCUT).

---

###
```{r dcut, echo = FALSE}
DT::datatable(dcut, filter = 'top', options = list(scrollX = TRUE, fixedColumns = TRUE))
```

## Patient Cut 

### Patient Cut Datasets 

Patient cut to an SDTMv dataset (i.e. subset SDTMv observations on patients included in the dataset_cut input dataset).

Input dataset plus a flag DCUT_TEMP_REMOVE to indicate which observations would be dropped when a patient level datacut is applied.

***For ease of interpretation, the records where death dates have been removed are flagged*** <span style="color: red;">***RED.***

---

### {.tabset}
```{r, results='asis', echo = FALSE}
sum_test(patient_cut_data)
#df_tabs(patient_cut_data)
df_tables(patient_cut_data)

# lapply(patient_cut_data, function(df){
#   datatable(NULL)
#       name <- names(df)
#       cat("####", toupper(name), " \n")
#         x <- length(which(df$DCUT_TEMP_REMOVE == "Y"))
#         cat(paste("Number of records removed in ", toupper(name), ": ", x, " \n", " \n"))
#         print(htmltools::tagList(DT::datatable(df, filter = 'top', 
#                                                options = list(scrollX = TRUE, fixedColumns = TRUE)) %>%
#                                    formatStyle("DCUT_TEMP_REMOVE",
#                                                 target = "row",
#                                                 color = 'black', 
#                                                 backgroundColor = styleEqual("Y",'#FFDFDF'))))
#         cat(' \n\n')
# })
```


## Date Cut 

### Date Cut Datasets

xxSTDTC or xxDTC Cut

Use to apply a datacut to either an xxSTDTC or xxDTC SDTM date variable. 
The datacut date from the datacut dataset is merged on to the input SDTMv dataset and renamed to `TEMP_DCUT_DCUTDTM`.
A flag `TEMP_DCUT_REMOVE` is added to the dataset to indicate the observations that would be removed when the cut is applied.

Note that this function applies a patient level datacut at the same time (using the `pt_cut()` function), and also imputes dates in the specified SDTMv dataset (using the `impute_sdtm()` function).

Input dataset plus a flag TEMP_DCUT_REMOVE to indicate which observations would be dropped when a datacut is applied.

***For ease of interpretation, the records where death dates have been removed are flagged*** <span style="color: red;">***RED.***

---

### {.tabset}
```{r, results='asis', echo = FALSE}
sum_test(date_cut_data)
df_tabs(date_cut_data)
```

## Special DM Cut 

### Special DM cut dataset

Special DM Cut to reset Death variable information past cut date

Applies patient cut if patient not in source DCUT, as well as clearing death information within DM if death occurred after datacut date.

Input dataset plus a flag DCUT_TEMP_REMOVE to indicate which observations would be dropped when a datacut is applied, and a flag DCUT_TEMP_DTHCHANGE to indicate which observations have death occurring after data cut date for clearing.

***For ease of interpretation, the records where death dates have been modified are flagged*** <span style="color: blue;">***BLUE.***

***The records where death dates have been removed are flagged*** <span style="color: red;">***RED.***

---

### {.tabset}
```{r dm_cut, results='asis', echo = FALSE}
sum_test(dm_cut)
# df_tabs(dm_cut)
dm_tab(dm_cut)
```

## Final Data

### Final datasets

Uncut data added to the cut data.

---

### {.tabset}
```{r, results='asis', echo = FALSE}
df_tabs(final_data)
```
